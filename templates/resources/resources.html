{% extends 'base.html' %}
{% load static %}

{% block title %}
    AERPAW Resources
{% endblock %}

{% block content %}
    {% if user.is_authenticated %}
        <head>
          <meta charset="utf-8">
          <title>Resources</title>
          <script src="../static/js/echarts.js"></script>
          <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
        </head>
        <div class="container">
          <div class="d-flex flex-row align-items-center justify-content-between">
            <h2>AERPAW Resources</h2>
            <button class="btn btn-success mr-2">
              <a href="{% url 'resource_create' %}" class="unlink">Create New Resource</a>
            </button>
          </div>
          <div class="container py-4">
            <!-- <div class="toolbar">
              <div class="input-group mb-3 toolbar-dropdown">
                <div class="input-group-prepend">
                  <label class="input-group-text" for="inputGroupSelect01">Type</label>
                </div>
                <select class="custom-select" id="inputGroupSelect01">
                  <option selected>Fixed Node</option>
                  <option value="1">Portable Nodes</option>
                  <option value="2">Cloud VMs</option>
                  <option value="3">Commercial BS</option>
                  <option value="4">RF Sensors</option>
                  <option value="5">Lora</option>
                  <option value="6">Terragraph</option>
                  <option value="7">CICD Ports</option>
                  <option value="8">All Types</option>
                </select>
              </div>
            </div> -->
            <!-- prepare a DOM container with width and height -->
            <div id="main" style="width: 1000px;height:400px;" class="mt-4"></div>
          </div>
          <table class="table table-striped table-bordered mt-4">
              <tr>
                <th>Name</th>
                <th>UUID</th>
                <th>Description</th>
                <th>Resource Type</th>
                <th>Units</th>
                <th>Available Units</th>
                <th>Location</th>
                <th>Stage</th>
                <th>Admin</th>
                <th>Created Date</th>
              </tr>
              {% for resource in resources %}
                  <tr>
                      <td>
                          <a href="{% url 'resource_detail' resource_uuid=resource.uuid %}">
                              {{ resource.name }}
                          </a>
                      </td>
                      <td>{{ resource.uuid }}</td>
                      <td>{{ resource.description }}</td>
                      <td>{{ resource.resourceType }}</td>
                      <td>{{ resource.units }}</td>
                      <td>{{ resource.availableUnits }}</td>
                      <td>{{ resource.location }}</td>
                      <td>{{ resource.stage }}</td>
                      <td>{{ resource.admin }}</td>
                      <td>{{ resource.created_date }}</td>
                  </tr>
              {% endfor %}
          </table>
          <input type="hidden" id="hidden-reservations" name="variable" value="{{ reservations_json }}">
          <input type="hidden" id="hidden-resources" name="variable" value="{{ resources_json }}">
        </div>
    {% else %}
        <div class="container">
            <p>You are not currently logged in or not authorized to view this page</p>
        </div>
    {% endif %}
    <script type="text/javascript">
      // based on prepared DOM, initialize echarts instance
      let myChart = echarts.init(document.getElementById('main'));
      let reservations_json = JSON.parse(document.getElementById("hidden-reservations").value);
      let resources_json = JSON.parse(document.getElementById("hidden-resources").value);

      // dynamically generate diagram config options.
      const x_axis_data = [];
      const legend = [];
      const series = [];
      let step = 1;
      for (const key in reservations_json) {
        const res_name = resources_json[key].name
        let series_obj = { 
          name: res_name,
          type: "line",
          step: step,
          data: reservations_json[key]
        };
        step += 1;
        legend.push(res_name);
        series.push(series_obj);
      }

      let n_of_terms = series[0].data.length;
      let date = new Date();
      let year = date.getUTCFullYear();
      let month = date.getUTCMonth();
      let day = date.getUTCDate();
      let hour = date.getHours();
      let utc_hour = (hour + 5) % 24;
      let full_date = year + "/" + month + "/" + day;
      
      for (let i = utc_hour; i < n_of_terms + utc_hour; i++) {
        if (i > 24) {
          full_date = year + "/" + month + "/" + (day + 1);
        } 
        let time = moment(i % 24,'HH').format('HH:mm') + " " + full_date;
        x_axis_data.push(time)
      }

      // specify chart configuration item and data
      let option = {
        title: {
            text:''
        },
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: legend
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        toolbox: {
            feature: {
            }
        },
        xAxis: {
            type: 'category',
            data: x_axis_data,
        },
        yAxis: {
            type: 'value'
        },
        dataZoom: [
            {
                type: 'slider',
                show: true,
                xAxisIndex: [0],
                start: 0,
                end: 100
            },
        ],
        series: series,
    };

      // use configuration item and data specified to show chart
      myChart.setOption(option);
  </script>
{% endblock %}